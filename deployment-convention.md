# 公共治安综合平台部署规范

本文档适合《公共治安综合平台》项目团队的部署人员阅读。



## 1. 部署编号

部署到服务器上时，应使用虚拟主机，并对其进行编号。编号采用2位数字的方式：
- 第1位数字表示项目。
- 第2位数字表示阶段，其中1表示alpha、2表示beta、3表示staging、4表示live。



## 2. 项目代号

平台的每个服务，都有一个代号，参考[服务定义](service-definition.md)。



## 3. 项目阶段

项目的部署分为以下阶段：

<table class="table table-striped table-hover">
  <thead>
    <tr>
      <th>代号</th>
      <th>阶段</th>
      <th>用途</th>
      <th>典型发布周期</th>
      <th>稳定性</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>alpha</td>
      <td>内部测试</td>
      <td>
        <ul>
          <li>测试团队的内部测试</li>
          <li>与内部其他系统进行集成</li>
        </ul>
      </td>
      <td>每日数次</td>
      <td>在修复问题阶段，会频繁发布，因此数据、网络服务不稳定。</td>
    </tr>
    <tr>
      <td>beta</td>
      <td>外部测试</td>
      <td>
        <ul>
          <li>测试团队以外的公开测试</li>
        </ul>
      </td>
      <td>每日一次</td>
      <td>在修复问题阶段，稳定地发布一系列的修复和改进。</td>
    </tr>
    <tr>
      <td>staging</td>
      <td>试运行</td>
      <td>
        <ul>
          <li>向最终用户演示</li>
          <li>面向最终用户的培训</li>
        </ul>
      </td>
      <td>每月数次</td>
      <td>比较稳定。</td>
    </tr>
    <tr>
      <td>live</td>
      <td>正式上线</td>
      <td>
        <ul>
          <li>供最终用户正式使用</li>
        </ul>
      </td>
      <td>每月一次</td>
      <td>很稳定。</td>
    </tr>
  </tbody>
</table>



## 4. 部署仓库

部署仓库是指仓库名为 *-deploy 的仓库。
1. 主平台的虚拟主机配置，首先按照域名分组。
2. 每个域名下都有2个目录：ssl-certs (SSL数字证书) 和 vhosts (虚拟主机配置文件) 。以后还可能有 apns-certs (APNs数字证书)、gcm-certs (GCM数字证书) 等。
3. ssl-certs 目录下存储SSL数字证书文件，如：
  - domain.name.cert
  - domain.name.key
4. vhosts 目录下存储该域名对应的虚拟主机配置文件。文件名中应包含Web服务器名称，如：
  - nginx-passenger-domain.name.conf
  - apache-fcgi-domain.name.conf



## 5. 验收流程

1. 部署工程师根据部署需求和实际软件、硬件、网络环境，编写对应域名的虚拟主机配置文件。
2. 部署工程师根据域名生成数字证书。
3. 部署工程师向 git 服务器提交虚拟主机和数字证书。
4. 部署测试工程师在仿真环境中测试 git 服务器上的虚拟主机配置文件和数字证书。
5. 如果测试不通过，则返回 #1 ，直至通过。



## 6. 部署流程

1. 部署工程师从 git 服务器上获得虚拟主机和数字证书。
2. 部署工程师备份应用服务器旧的配置文件。
3. 部署工程师向应用服务器部署新的配置文件。
4. 部署工程师启用新的配置文件，并进行简单的配置验证。
5. 如果配置验证不通过，则恢复 #2 备份的配置文件，回退部署，然后重新进入 [配置文件的验收流程](#2-配置文件的验收流程) 。
6. 部署工程师宣布部署成功。
